name: üèÉ‚Äç‚ôÇÔ∏è Repo Create / Import / Migrate
run-name: ${{ github.event_name == 'workflow_dispatch' && format('{0} | {1} | {2} | {3} | {4}', github.run_number, inputs.team-name, inputs.repo-name, inputs.criticality, inputs.clone-url) || format('{0} | Migration Request from Issue {1}', github.run_number, github.event.issue.number) }}

on:
  workflow_dispatch:
    inputs:
      #####################################################################
      # Organization
      #####################################################################
      org:
        description: 'GitHub Organization'
        type: string
        default: ''
        required: true

      #####################################################################
      # Team Management
      #####################################################################
      team-name:
        description: 'Team Name. The GitHub team that will have maintain permissions. LOWER CASE, hyphen-separated, No Spaces.'
        required: true
        type: string

      parent-team-name:
        description: 'Parent Team Name (Optional). The parent team in the team hierarchy. LOWER CASE, hyphen-separated, No Spaces.'
        required: false
        type: string
        default: ''

      admin-team-name:
        description: 'Admin Team Name. The GitHub team that will have admin permissions. LOWER CASE, hyphen-separated, No Spaces. Default: {team-name}-admins'
        required: false
        type: string
        default: ''

      #####################################################################
      # Repository
      #####################################################################
      repo-name:
        description: 'Repository Name. LOWER CASE, hyphen-separated, No Spaces'
        required: true
        type: string

      #####################################################################
      # Migration Options
      #####################################################################
      only-folder:
        description: '(Optional). Only include a specific folder. This is in cases where you are trying to migrate a folder in a repo.'
        required: false
        default: ''
        type: string

      #####################################################################
      # Security
      #####################################################################
      criticality:
        description: 'Criticality. L1/L2 would be considered critical. L3/L4 would be considered non-critical.'
        required: true
        default: non-critical
        type: choice
        options:
          - critical
          - non-critical

      #####################################################################
      clone-url:
        description: '(Optional) Clone URL. (Only Required if migrating from either ADO, BitBucket, svn, or another github repo)'
        required: false
        type: string

  issues:
    types: [opened]

env:
  rename: 'no'

jobs:
  # Process issue and trigger workflow if it's a migration request
  setup:
    runs-on: ubuntu-latest
    if: ${{ github.event_name == 'workflow_dispatch' || (github.event_name == 'issues' && contains(github.event.issue.labels.*.name, 'migration-request')) }}
    outputs:
      org: ${{ steps.set-values-dispatch.outputs.org || steps.extract-values.outputs.org }}
      team-name: ${{ steps.set-values-dispatch.outputs.team-name || steps.extract-values.outputs.team-name }}
      parent-team-name: ${{ steps.set-values-dispatch.outputs.parent-team-name || steps.extract-values.outputs.parent-team-name }}
      admin-team-name: ${{ steps.set-values-dispatch.outputs.admin-team-name || steps.extract-values.outputs.admin-team-name }}
      repo-name: ${{ steps.set-values-dispatch.outputs.repo-name || steps.extract-values.outputs.repo-name }}
      only-folder: ${{ steps.set-values-dispatch.outputs.only-folder || steps.extract-values.outputs.only-folder }}
      criticality: ${{ steps.set-values-dispatch.outputs.criticality || steps.extract-values.outputs.criticality }}
      clone-url: ${{ steps.set-values-dispatch.outputs.clone-url || steps.extract-values.outputs.clone-url }}
      should-run: ${{ steps.set-values-dispatch.outputs.should-run || steps.extract-values.outputs.should-run }}
      gh-org: ${{ env.GH_ORG }}
      gh-repo: ${{ env.GH_REPO }}
      repo-url: ${{ env.REPO_URL }}
      private: ${{ env.PRIVATE }}
      teams: ${{ env.TEAMS }}
    steps:
      # For workflow_dispatch events - use inputs directly
      - name: Set values from workflow inputs
        if: ${{ github.event_name == 'workflow_dispatch' }}
        id: set-values-dispatch
        run: |
          {
            echo "org=${{ inputs.org || vars.DEFAULT_GITHUB_ORG || 'my-org' }}"
            echo "team-name=${{ inputs.team-name }}"
            echo "parent-team-name=${{ inputs.parent-team-name }}"
            echo "admin-team-name=${{ inputs.admin-team-name || format('{0}-admins', inputs.team-name) }}"
            echo "repo-name=${{ inputs.repo-name }}"
            echo "only-folder=${{ inputs.only-folder }}"
            echo "criticality=${{ inputs.criticality }}"
            echo "clone-url=${{ inputs.clone-url }}"
            echo "should-run=true"
          } >> "$GITHUB_OUTPUT"

      - name: Set environment variables for workflow_dispatch
        if: ${{ github.event_name == 'workflow_dispatch' }}
        run: |
          {
            echo "PRIVATE=${{ inputs.criticality == 'critical' && 'true' || 'false' }}"
            echo "GH_ORG=${{ inputs.org || vars.DEFAULT_GITHUB_ORG || 'my-org' }}"
            echo "GH_REPO=${{ inputs.repo-name }}"
            echo "REPO_URL=https://github.com/${{ inputs.org || vars.DEFAULT_GITHUB_ORG || 'my-org' }}/${{ inputs.repo-name }}"
          } >> "$GITHUB_ENV"
          # Create teams JSON structure
          PARENT_TEAM="${{ inputs.parent-team-name }}"
          ADMIN_TEAM="${{ inputs.admin-team-name || format('{0}-admins', inputs.team-name) }}"

          if [ -n "$PARENT_TEAM" ]; then
            cat << EOF >> "$GITHUB_ENV"
          TEAMS<<EOJSON
          [
            {
              "name": "$PARENT_TEAM",
              "permission": "${{ inputs.criticality == 'critical' && 'none' || 'pull' }}",
              "privacy": "closed"
            },
            {
              "name": "${{ inputs.team-name }}",
              "parent": "$PARENT_TEAM",
              "permission": "maintain",
              "privacy": "closed"
            },
            {
              "name": "$ADMIN_TEAM",
              "parent": "${{ inputs.team-name }}",
              "permission": "admin",
              "privacy": "closed"
            }
          ]
          EOJSON
          EOF
          else
            cat << EOF >> "$GITHUB_ENV"
          TEAMS<<EOJSON
          [
            {
              "name": "${{ inputs.team-name }}",
              "permission": "maintain",
              "privacy": "closed"
            },
            {
              "name": "$ADMIN_TEAM",
              "parent": "${{ inputs.team-name }}",
              "permission": "admin",
              "privacy": "closed"
            }
          ]
          EOJSON
          EOF
          fi

      # For issues events - process the issue content
      - name: Checkout repository
        if: ${{ github.event_name == 'issues' }}
        uses: actions/checkout@v4

      - name: Extract values from issue
        if: ${{ github.event_name == 'issues' }}
        id: extract-values
        env:
          ISSUE_BODY: ${{ github.event.issue.body }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Parse values from issue body

          # GitHub Organization
          ORG=$(echo "$ISSUE_BODY" | awk '/^### üè¢ GitHub Organization/{getline; if(!$0) getline; print $0}' | xargs)
          if [ -z "$ORG" ]; then
            ORG=$(echo "$ISSUE_BODY" | awk '/^### GitHub Organization$/{getline; if(!$0) getline; print $0}' | xargs)
          fi

          # Team Name
          TEAM_NAME=$(echo "$ISSUE_BODY" | awk '/^### üë• Team Name/{getline; if(!$0) getline; print $0}' | xargs)
          if [ -z "$TEAM_NAME" ]; then
            TEAM_NAME=$(echo "$ISSUE_BODY" | awk '/^### Team Name$/{getline; if(!$0) getline; print $0}' | xargs)
          fi

          # Repository Name
          REPO_NAME=$(echo "$ISSUE_BODY" | awk '/^### üì¶ Repository Name/{getline; if(!$0) getline; print $0}' | xargs)
          if [ -z "$REPO_NAME" ]; then
            REPO_NAME=$(echo "$ISSUE_BODY" | awk '/^### Repository Name$/{getline; if(!$0) getline; print $0}' | xargs)
          fi

          # Only Include Specific Folder
          ONLY_FOLDER=$(echo "$ISSUE_BODY" | awk '/^### üìÅ Only Include Specific Folder/{getline; if(!$0) getline; print $0}' | xargs | sed 's/^_No response_$//')
          if [ -z "$ONLY_FOLDER" ]; then
            ONLY_FOLDER=$(echo "$ISSUE_BODY" | awk '/^### Only Include Specific Folder$/{getline; if(!$0) getline; print $0}' | xargs | sed 's/^_No response_$//')
          fi

          # Criticality Level
          CRITICALITY=$(echo "$ISSUE_BODY" | awk '/^### üîí Criticality Level/{getline; if(!$0) getline; print $0}' | xargs)
          if [ -z "$CRITICALITY" ]; then
            CRITICALITY=$(echo "$ISSUE_BODY" | awk '/^### Criticality$/{getline; if(!$0) getline; print $0}' | xargs)
          fi

          # Source Repository URL
          CLONE_URL=$(echo "$ISSUE_BODY" | awk '/^### üîó Source Repository URL/{getline; if(!$0) getline; print $0}' | xargs | sed 's/^_No response_$//')
          if [ -z "$CLONE_URL" ]; then
            CLONE_URL=$(echo "$ISSUE_BODY" | awk '/^### Clone URL$/{getline; if(!$0) getline; print $0}' | xargs | sed 's/^_No response_$//')
          fi

          # Set default values if empty
          if [ -z "$ORG" ]; then ORG=$GITHUB_REPOSITORY_OWNER; fi
          if [ -z "$ONLY_FOLDER" ]; then ONLY_FOLDER=""; fi
          if [ -z "$CLONE_URL" ]; then CLONE_URL=""; fi
          if [ -z "$CRITICALITY" ]; then CRITICALITY="non-critical"; fi

          # Validate required values
          SHOULD_RUN="true"
          FORMAT_USED="unknown"

          # Determine which format was successfully parsed
          if echo "$ISSUE_BODY" | grep -q "^### üè¢ GitHub Organization"; then
            FORMAT_USED="new"
          elif echo "$ISSUE_BODY" | grep -q "^### GitHub Organization$"; then
            FORMAT_USED="old"
          fi

          # Check for required values
          MISSING_FIELDS=""
          if [ -z "$TEAM_NAME" ]; then MISSING_FIELDS="$MISSING_FIELDS team-name"; fi
          if [ -z "$REPO_NAME" ]; then MISSING_FIELDS="$MISSING_FIELDS repo-name"; fi

          if [ -n "$MISSING_FIELDS" ]; then
            SHOULD_RUN="false"
          fi

          # Create formatted run name for issue title
          ADMIN_TEAM="${TEAM_NAME}-admins"
          ISSUE_TITLE="$TEAM_NAME | $REPO_NAME | $CRITICALITY | $CLONE_URL"

          # Output values for next jobs
          {
            echo "org=$ORG"
            echo "team-name=$TEAM_NAME"
            echo "parent-team-name="
            echo "admin-team-name=$ADMIN_TEAM"
            echo "repo-name=$REPO_NAME"
            echo "only-folder=$ONLY_FOLDER"
            echo "criticality=$CRITICALITY"
            echo "clone-url=$CLONE_URL"
            echo "should-run=$SHOULD_RUN"
            echo "issue-title=$ISSUE_TITLE"
            echo "format-used=$FORMAT_USED"
            echo "missing-fields=$MISSING_FIELDS"
          } >> "$GITHUB_OUTPUT"

      - name: Add parsing status comment to issue
        if: ${{ github.event_name == 'issues' }}
        uses: peter-evans/create-or-update-comment@v4
        with:
          issue-number: ${{ github.event.issue.number }}
          body: |
            ## üîç Issue Parsing Results

            **Format detected:** `${{ steps.extract-values.outputs.format-used }}`
            **Parsing status:** ${{ steps.extract-values.outputs.should-run == 'true' && '‚úÖ Success' || '‚ùå Failed' }}

            ${{ steps.extract-values.outputs.should-run == 'false' && format('**Missing required fields:** {0}', steps.extract-values.outputs.missing-fields) || '' }}

            ${{ steps.extract-values.outputs.should-run == 'false' && '‚ö†Ô∏è **Action Required:** Please edit this issue and ensure all required fields are filled out correctly.' || '' }}

      - name: Fail workflow if parsing failed
        if: ${{ github.event_name == 'issues' && steps.extract-values.outputs.should-run == 'false' }}
        run: |
          echo "‚ùå Issue parsing failed. Missing required fields: ${{ steps.extract-values.outputs.missing-fields }}"
          echo "Format detected: ${{ steps.extract-values.outputs.format-used }}"
          exit 1

      - name: Set environment variables for issue
        if: ${{ github.event_name == 'issues' && steps.extract-values.outputs.should-run == 'true' }}
        run: |
          {
            echo "PRIVATE=${{ steps.extract-values.outputs.criticality == 'critical' && 'true' || 'false' }}"
            echo "GH_ORG=${{ steps.extract-values.outputs.org }}"
            echo "GH_REPO=${{ steps.extract-values.outputs.repo-name }}"
            echo "REPO_URL=https://github.com/${{ steps.extract-values.outputs.org }}/${{ steps.extract-values.outputs.repo-name }}"
          } >> "$GITHUB_ENV"
          # Create teams JSON structure
          cat << EOF >> "$GITHUB_ENV"
          TEAMS<<EOJSON
          [
            {
              "name": "${{ steps.extract-values.outputs.team-name }}",
              "permission": "maintain",
              "privacy": "closed"
            },
            {
              "name": "${{ steps.extract-values.outputs.admin-team-name }}",
              "parent": "${{ steps.extract-values.outputs.team-name }}",
              "permission": "admin",
              "privacy": "closed"
            }
          ]
          EOJSON
          EOF

      - name: Rename issue to match run name
        if: ${{ github.event_name == 'issues' }}
        run: |
          gh issue edit ${{ github.event.issue.number }} --repo ${{ github.repository }} --title "[migration-request #${{ github.run_number }}]: ${{ steps.extract-values.outputs.issue-title }}"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Add status comment to issue
        if: ${{ github.event_name == 'issues' && steps.extract-values.outputs.should-run == 'true' }}
        uses: peter-evans/create-or-update-comment@v4
        with:
          issue-number: ${{ github.event.issue.number }}
          body: |
            ‚úÖ Migration automatically started with the following parameters:

            - Organization: `${{ steps.extract-values.outputs.org }}`
            - Team Name: `${{ steps.extract-values.outputs.team-name }}`
            - Repository Name: `${{ steps.extract-values.outputs.repo-name }}`
            - Only Folder: `${{ steps.extract-values.outputs.only-folder }}`
            - Criticality: `${{ steps.extract-values.outputs.criticality }}`
            - Clone URL: `${{ steps.extract-values.outputs.clone-url }}`

            Migration is now in progress. Check workflow status at: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}

      - name: Set outputs for environment variables
        if: ${{ github.event_name == 'workflow_dispatch' || (github.event_name == 'issues' && steps.extract-values.outputs.should-run == 'true') }}
        id: set-env-outputs
        run: |
          {
            echo "gh-org=${{ env.GH_ORG }}"
            echo "gh-repo=${{ env.GH_REPO }}"
            echo "repo-url=${{ env.REPO_URL }}"
            echo "private=${{ env.PRIVATE }}"
            # Start the teams multiline output within the same block
            echo "teams<<EOJSON"
            echo "${{ env.TEAMS }}"
            echo "EOJSON"
          } >> "$GITHUB_OUTPUT"

  # Main migration job - triggered either directly or from issue
  create:
    runs-on: ubuntu-latest
    needs: [setup]
    defaults:
      run:
          shell: pwsh
    env:
      GH_ORG: ${{ needs.setup.outputs.gh-org }}
      GH_REPO: ${{ needs.setup.outputs.gh-repo }}
      REPO_URL: ${{ needs.setup.outputs.repo-url }}
      PRIVATE: ${{ needs.setup.outputs.private }}
      TEAMS: ${{ needs.setup.outputs.teams }}
    steps:

      - name: Checkout
        uses: actions/checkout@v4

      - name: Prepare
        run: |
          $env:JOB_SUMMARY_FILE = "$($env:GITHUB_WORKSPACE)/job_summary.md"
          Write-Output "JOB_SUMMARY_FILE=$($env:JOB_SUMMARY_FILE)" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append

          Write-Output "| Name | Status | Notes  |" | Out-File -FilePath $env:JOB_SUMMARY_FILE -Encoding utf8 -Append
          Write-Output "| ---- | ------ | ------ |" | Out-File -FilePath $env:JOB_SUMMARY_FILE -Encoding utf8 -Append

      - name: ‚úÖ Validate Team Name and Repo Name
        env:
          TEAM_NAME: ${{ needs.setup.outputs.team-name }}
          REPO_NAME: ${{ needs.setup.outputs.repo-name }}
        run: |
          $statusCode = 0
          # Validate team-name. Must be lowercase, no spaces, no special characters except for "-". Must start and end with a letter or number
          $teamName = $env:TEAM_NAME
          if($teamName -notmatch '^[a-z0-9][a-z0-9-]*[a-z0-9]$'){
            Write-Output "| **Team Name** | ‚ùå | Must be lowercase, no spaces, no special characters except for ``-``. Must start and end with a letter or number |" | Out-File -FilePath $env:JOB_SUMMARY_FILE -Encoding utf8 -Append
            $statusCode = 1
          }
          else{
            Write-Output "| **Team Name** | ‚úÖ | $($teamName) |" | Out-File -FilePath $env:JOB_SUMMARY_FILE -Encoding utf8 -Append
          }


          # Validate repo-name. Must be lowercase, no spaces, no special characters except for "-". Must start and end with a letter or number
          $repoName = $env:REPO_NAME
          if($repoName -notmatch '^[a-z0-9][a-z0-9-]*[a-z0-9]$'){
            Write-Output "| **Repo Name** | ‚ùå | Must be lowercase, no spaces, no special characters except for ``-``. Must start and end with a letter or number |" | Out-File -FilePath $env:JOB_SUMMARY_FILE -Encoding utf8 -Append
            $statusCode = 1
          }
          else{
            Write-Output "| **Repo Name** | ‚úÖ | $($repoName) |" | Out-File -FilePath $env:JOB_SUMMARY_FILE -Encoding utf8 -Append
          }

          exit $statusCode

      - name: üîë Validate Team Membership
        id: team-validation
        env:
          GH_APP_CERTIFICATE: ${{ secrets.GH_APP_PRIVATE_KEY }}
          GH_APP_ID: ${{ vars.GH_APP_ID }}
          ORG: ${{ needs.setup.outputs.org }}
          TEAM_NAME: ${{ needs.setup.outputs.team-name }}
          TRIGGERING_ACTOR: ${{ github.triggering_actor }}
        run: |
          . "${{github.workspace}}/scripts/modules.ps1"
          Update-GitHubToken -Organization $env:ORG

          # Use the team name directly
          $teamName = $env:TEAM_NAME
          $username = $env:TRIGGERING_ACTOR

          Write-Output "| **Team Membership Validation** | üèÉ | Checking if user ``$username`` is member of team ``$teamName`` |" | Out-File -FilePath $env:JOB_SUMMARY_FILE -Encoding utf8 -Append

          # Check if user is a member of the team
          $isMember = Test-UserTeamMembership -Org $env:ORG -TeamSlug $teamName -Username $username

          if (-not $isMember) {
            $errorMessage = "Repository creation failed. You are not a member of the team ``$teamName`` required to create this repository. Please contact the team administrator or your organization administrator to request access."
            Write-Output "| **Team Membership Validation** | ‚ùå | $errorMessage |" | Out-File -FilePath $env:JOB_SUMMARY_FILE -Encoding utf8 -Append
            Write-Output "team-membership-failed=true" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append
            throw $errorMessage
          }
          else {
            Write-Output "| **Team Membership Validation** | ‚úÖ | User ``$username`` is authorized to create this repository |" | Out-File -FilePath $env:JOB_SUMMARY_FILE -Encoding utf8 -Append
            Write-Output "team-membership-failed=false" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append
          }

      #####################################################################
      # Pre work
      #####################################################################
      - name: üèÉ Parse Import Clone URL
        id: url
        env:
          IMPORT_URL: ${{ needs.setup.outputs.clone-url }}
        run: |
          & "${{github.workspace}}/scripts/New-ImportRepoDetails.ps1"


      #####################################################################
      # Create
      #####################################################################
      - name: üèÉ Create GitHub Repo
        id: create
        env:
          GH_APP_CERTIFICATE: ${{ secrets.GH_APP_PRIVATE_KEY }}
          GH_APP_ID: ${{ vars.GH_APP_ID }}
          GITHUB_REPO_URL: ${{ env.REPO_URL }}
          GIT_NAME: ${{ vars.GH_APP_NAME }}[bot]
          GIT_EMAIL: ${{ vars.GH_APP_USER_ID }}+${{ vars.GH_APP_NAME }}[bot]@users.noreply.github.com
        run: |
          & "${{github.workspace}}/scripts/New-GitHubRepo.ps1"  -githubRepoUrl $($env:GITHUB_REPO_URL)

      #####################################################################
      # Rename if needed
      #####################################################################
      - name: üèÉ Rename GitHub Repo
        if: ${{ fromJson(steps.url.outputs.results).source == 'github' && env.rename == 'yes' }}
        env:
          GH_APP_CERTIFICATE: ${{ secrets.GH_APP_PRIVATE_KEY }}
          GH_APP_ID: ${{ vars.GH_APP_ID }}
          NEW_ORG: ${{ env.GH_ORG }}
          NEW_REPO: ${{ env.GH_REPO }}
          OLD_ORG: ${{ fromJson(steps.url.outputs.results).organization }}
          OLD_REPO: ${{ fromJson(steps.url.outputs.results).repo }}
        run: |
          # Error if old org is not the same as new org since its not supported at this time
          if($env:OLD_ORG -ine $env:NEW_ORG){
            Write-Output "| **Old Org** | ‚ùå | Old Org ``$($env:OLD_ORG)`` is not the same as new org ``$($env:NEW_ORG)``. This is not supported at this time. |" | Out-File -FilePath $env:JOB_SUMMARY_FILE -Encoding utf8 -Append
            exit 1
          }
          . "${{github.workspace}}/scripts/modules.ps1"
          Update-GitHubToken -Organization $($env:OLD_ORG)
          Invoke-GitHubApiRoute -Method PATCH -Path "repos/$($env:OLD_ORG)/$($env:OLD_REPO)" -Body $(@{
            name = $env:NEW_REPO
          } | ConvertTo-Json)
          Write-Output "| **Renaming Repo** | ‚úÖ | ``$($env:OLD_ORG)/$($env:OLD_REPO)`` to ``$($env:NEW_ORG)/$($env:NEW_REPO)`` |" | Out-File -FilePath $env:JOB_SUMMARY_FILE -Encoding utf8 -Append


      #####################################################################
      # Migrate
      #####################################################################
      - name: üèÉ Migrate ADO Repo to GitHub Repo
        id: import
        if: ${{ fromJson(steps.url.outputs.results).source != 'none' }}
        env:
          GH_APP_CERTIFICATE: ${{ secrets.GH_APP_PRIVATE_KEY }}
          GH_APP_ID: ${{ vars.GH_APP_ID }}
          ADO_PAT: ${{ secrets.ADO_PAT }}
          BB_USERNAME: ${{ secrets.BB_USERNAME }}
          BB_PASSWORD: ${{ secrets.BB_PAT }}
          ORG: ${{ env.GH_ORG }}
          REPO: ${{ env.GH_REPO }}
          GIT_NAME: ${{ vars.GH_APP_NAME }}[bot]
          GIT_EMAIL: ${{ vars.GH_APP_USER_ID }}+${{ vars.GH_APP_NAME }}[bot]@users.noreply.github.com
          INCLUDE_ONLY_PATH: ${{ needs.setup.outputs.only-folder }}
          SVN_SERVICE_USERNAME: ${{ vars.SVN_SERVICE_USERNAME }}
          SVN_SERVICE_PASSWORD: ${{ secrets.SVN_SERVICE_PASSWORD }}
          SUBVERSION_SERVICE_USERNAME: ${{ vars.SUBVERSION_SERVICE_USERNAME }}
          SUBVERSION_SERVICE_PASSWORD: ${{ secrets.SUBVERSION_SERVICE_PASSWORD }}
        run: |
          & "${{github.workspace}}/scripts/New-GitHubRepoMigration.ps1"

      #####################################################################
      # Generate Token
      #####################################################################
      - name: üîë Generate Token
        id: app-token
        env:
          GH_APP_CERTIFICATE: ${{ secrets.GH_APP_PRIVATE_KEY }}
          GH_APP_ID: ${{ vars.GH_APP_ID }}
          ORG: ${{ env.GH_ORG }}
          REPO: ${{ fromJson(steps.url.outputs.results).repo }}
        run: |
          . "${{github.workspace}}/scripts/modules.ps1"
          Update-GitHubToken -Organization $($env:ORG)
          $token = $env:GH_TOKEN
          Write-Output "token=$token" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append

      ######################################################################
      # üîì Add Branch Protection Exceptions
      ######################################################################
      - name: üîì Add Branch Protection Exceptions
        uses: ./.github/actions/branch-protection-bypass
        id: clear-branch-protection
        with:
          app-slug: ${{ vars.GH_APP_NAME }}
          repository: ${{ env.GH_ORG }}/${{ env.GH_REPO }}
          token: ${{ steps.app-token.outputs.token }}

      #####################################################################
      # Add Custom Properties (DISABLED - Use @custom-properties agent to enable)
      #####################################################################
      # - name: ‚úèÔ∏è Add Custom Properties
      #   continue-on-error: true
      #   env:
      #     GH_APP_CERTIFICATE: ${{ secrets.GH_APP_PRIVATE_KEY }}
      #     GH_APP_ID: ${{ vars.GH_APP_ID }}
      #     REPO: https://github.com/${{ env.GH_ORG }}/${{ env.GH_REPO }}
      #     GIT_NAME: ${{ vars.GH_APP_NAME }}[bot]
      #     GIT_EMAIL: ${{ vars.GH_APP_USER_ID }}+${{ vars.GH_APP_NAME }}[bot]@users.noreply.github.com
      #     VALUE: |
      #       # Add your custom properties here in the format:
      #       # property_name=value
      #       # Example:
      #       # app_id=${{ needs.setup.outputs.app-id }}
      #       # category=${{ needs.setup.outputs.category }}
      #   run: |
      #     & "${{github.workspace}}/scripts/Add-CustomProperties.ps1" -githubRepoUrl $($env:REPO) -value $($env:VALUE)

      #####################################################################
      # Post work
      #####################################################################
      - name: üèÉ Set to internal
        if: ${{ env.PRIVATE == 'false' }}
        id: internal
        env:
          GH_APP_CERTIFICATE: ${{ secrets.GH_APP_PRIVATE_KEY }}
          GH_APP_ID: ${{ vars.GH_APP_ID }}
          ADO_PAT: ${{ secrets.ADO_PAT }}
          ORG: ${{ env.GH_ORG }}
          REPO: ${{ env.GH_REPO }}
        run: |
          . "${{github.workspace}}/scripts/modules.ps1"
          Update-GitHubToken -Organization $($env:ORG)

          Invoke-GitHubApiRoute -Path "repos/$($env:ORG)/$($env:REPO)" -Method PATCH -Body '{"visibility": "internal"}'

          Write-Output "| **Changing Repo to `Internal`** | ‚úÖ |  |" | Out-File -FilePath $env:JOB_SUMMARY_FILE -Encoding utf8 -Append

      #####################################################################

      - uses: nick-fields/retry@v2
        id: teams
        env:
          GH_APP_CERTIFICATE: ${{ secrets.GH_APP_PRIVATE_KEY }}
          GH_APP_ID: ${{ vars.GH_APP_ID }}
          ADO_PAT: ${{ secrets.ADO_PAT }}
          ORG: ${{ env.GH_ORG }}
          REPO: ${{ env.GH_REPO }}
          TEAMS: ${{ env.TEAMS }}
        with:
          max_attempts: 10
          retry_on: error
          timeout_minutes: 10
          shell: pwsh
          command: |
            . "${{github.workspace}}/scripts/modules.ps1"
            Update-GitHubToken -Organization $($env:ORG)

            # Get info
            $repo = Invoke-GitHubApiRoute -Path "repos/$($env:ORG)/$($env:REPO)"

            $teams = ConvertFrom-Json -InputObject $env:TEAMS
            $created = @()
            foreach($team in $teams){
              $teamName = $team.name
              $teamParent = $team.parent
              $teamPermission = $team.permission
              $teamDescription = $team.description
              $teamPrivacy = $team.privacy

              # Check if $teamName ends with '-'
              if($teamName.EndsWith('-')) {
                continue
              }
              $teamName = $teamName -replace '--', '-'

              $parentTeamId = $null
              if($teamParent){
                $parentTeam = $team = Invoke-GitHubApiRoute -Path "orgs/$($env:ORG)/teams/$($teamParent)"
                $parentTeamId = $parentTeam.id
              }

              $team = Invoke-GitHubApiRouteNullOn404 -Path "orgs/$($env:ORG)/teams/$($teamName)"
              if(-not $team){
                $body =@{
                  name = $teamName
                  description = $teamDescription
                  privacy = $teamPrivacy
                  maintainers = @( "${{ github.triggering_actor }}" )
                }
                if($parentTeamId) {
                  $body["parent_team_id"] = $parentTeamId
                }
                $team = Invoke-GitHubApiRoute -Path "orgs/$($env:ORG)/teams" -Method POST -Body $($body | ConvertTo-Json)
                $team
                $created += $team.slug

                Write-Output "| **Creating Team** | ‚úÖ | Maintainer ``${{ github.triggering_actor }}``  |" | Out-File -FilePath $env:JOB_SUMMARY_FILE -Encoding utf8 -Append
              }

              if($teamPermission -ne 'none'){
                Invoke-GitHubApiRoute -Path "orgs/$($env:ORG)/teams/$($teamName)/repos/$($env:ORG)/$($env:REPO)" -Method PUT -Body $(@{
                  permission = $teamPermission
                } | ConvertTo-Json)

                Write-Output "| **Add Repo Permission`** | ‚úÖ | Team ``$($teamName)``, Permission ``$($teamPermission)``  |" | Out-File -FilePath $env:JOB_SUMMARY_FILE -Encoding utf8 -Append
              }


            }

            # Reverse order
            $created_reverse = @()
            for($i = $created.Count - 1; $i -ge 0; $i--){
              $created_reverse += $created[$i]
            }

            Write-Output "created=$($created -join ',')" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append

      #####################################################################
      - name: üèÉ Rewrite-Pipeline(s) + ADO Integrations
        continue-on-error: true
        if: ${{  fromJson(steps.url.outputs.results).source == 'ado' && inputs.only-folder == '' }}
        env:
          GH_PAT: ${{ secrets.GH_PAT }}
          GH_TOKEN: ${{ secrets.GH_PAT }}
          GITHUB_TOKEN: ${{ secrets.GH_PAT }}
          GH_APP_CERTIFICATE: ${{ secrets.GH_APP_PRIVATE_KEY }}
          GH_APP_ID: ${{ vars.GH_APP_ID }}
          ADO_PAT: ${{ secrets.ADO_PAT }}
          AZURE_DEVOPS_EXT_PAT: ${{ secrets.ADO_PAT }}
          ADO_SERVICE_CONNECTION_ID: ${{ vars.ADO_SERVICE_CONNECTION_ID }}
          GITHUB_REPO_URL: https://github.com/${{ env.GH_ORG }}/${{ env.GH_REPO }}
        run: |
          & "${{github.workspace}}/scripts/Execute-ADOMigrationFinalization.ps1"   -githubRepoUrl $($env:GITHUB_REPO_URL)

      #####################################################################
      - name: üîí Lock ADO Repo
        if: ${{ fromJson(steps.url.outputs.results).source == 'ado' && inputs.only-folder == '' }}
        continue-on-error: true
        env:
          GH_TOKEN: ${{ secrets.GH_PAT }}
          GH_APP_CERTIFICATE: ${{ secrets.GH_APP_PRIVATE_KEY }}
          GH_APP_ID: ${{ vars.GH_APP_ID }}
          ADO_PAT: ${{ secrets.ADO_PAT }}
          AZURE_DEVOPS_EXT_PAT: ${{ secrets.ADO_PAT }}
          ADO_ORG: ${{ fromJson(steps.url.outputs.results).organization }}
          ADO_PROJECT: ${{ fromJson(steps.url.outputs.results).project }}
          ADO_REPO: ${{ fromJson(steps.url.outputs.results).repo }}
        run: |
          gh extension install github/gh-gei
          gh extension install github/gh-ado2gh

          $adoOrg = $env:ADO_ORG
          $adoProject = $env:ADO_PROJECT
          $adoRepo = $env:ADO_REPO

          gh ado2gh disable-ado-repo `
              --ado-org "$adoOrg" `
              --ado-team-project "$adoProject" `
              --ado-repo "$adoRepo"

      #####################################################################
      # Post work
      #####################################################################
      - name: ‚ùå Undo Creation of GitHub Repo
        if: ${{ failure() && steps.create.conclusion == 'success' && (fromJson(steps.url.outputs.results).source != 'github' || inputs.only-folder != '')  }}
        env:
          GH_APP_CERTIFICATE: ${{ secrets.GH_APP_PRIVATE_KEY }}
          GH_APP_ID: ${{ vars.GH_APP_ID }}
          ADO_PAT: ${{ secrets.ADO_PAT }}
          ORG: ${{ env.GH_ORG }}
          REPO: ${{ env.GH_REPO }}
          TEAMS: ${{ steps.teams.outputs.created }}
        run: |
          . "${{github.workspace}}/scripts/modules.ps1"
          Update-GitHubToken -Organization $($env:ORG)

          Invoke-GitHubApiRouteNullOn404 -Path "repos/$($env:ORG)/$($env:REPO)" -Method DELETE

          if([String]::IsNullOrEmpty($env:TEAMS)){
            return
          }

          $teams = $env:TEAMS -split ','
          foreach($team in $teams){
            Invoke-GitHubApiRouteNullOn404 -Path "orgs/$($env:ORG)/teams/$($team)" -Method DELETE
          }

      #####################################################################
      # Close the issue if it was triggered from an issue
      #####################################################################
      - name: üèÅ Close Issue with Success Comment
        if: ${{ success() && github.event_name == 'issues' }}
        uses: peter-evans/create-or-update-comment@v4
        with:
          issue-number: ${{ github.event.issue.number }}
          body: |
            ## ‚úÖ Migration Completed Successfully!

            Your repository has been successfully created and migrated to:
            üëâ [${{ env.GH_ORG }}/${{ env.GH_REPO }}](https://github.com/${{ env.GH_ORG }}/${{ env.GH_REPO }})

      - name: ‚ùå Notify Issue about Team Membership Failure
        if: ${{ failure() && github.event_name == 'issues' && steps.team-validation.outputs.team-membership-failed == 'true' }}
        uses: peter-evans/create-or-update-comment@v4
        with:
          issue-number: ${{ github.event.issue.number }}
          body: |
            ## üö´ Repository Creation Failed - Team Membership Required

            **Reason:** You are not a member of the team `${{ needs.setup.outputs.team-name }}` required to create this repository.

            **Next Steps:**
            - Contact the team administrator for `${{ needs.setup.outputs.team-name }}`
            - Or contact your organization administrator to request access to the team
            - Once you have been added to the team, you can re-run this migration request

            **Team Information:**
            - Required team: `${{ needs.setup.outputs.team-name }}`
            - Your username: `${{ github.triggering_actor }}`
            - Organization: `${{ needs.setup.outputs.org }}`

      - name: ‚ùå Notify Issue about Other Failures
        if: ${{ failure() && github.event_name == 'issues' && steps.team-validation.outputs.team-membership-failed != 'true' }}
        uses: peter-evans/create-or-update-comment@v4
        with:
          issue-number: ${{ github.event.issue.number }}
          body: |
            ## ‚ùå Migration Failed

            Unfortunately, the migration process failed. The workflow encountered an error.

            Please check the workflow logs for more details: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}

      - name: Close Issue
        if: ${{ always() && github.event_name == 'issues' }}
        run: |
          gh issue close ${{ github.event.issue.number }} --repo ${{ github.repository }} --reason "completed"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # Fix $env:JOB_SUMMARY_FILE table
      - name: üèÉ Fix Summary Table
        if: ${{ always() }}
        run: |
          Get-Content -Path $env:JOB_SUMMARY_FILE -Encoding utf8 -Raw | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Encoding utf8 -Force



